##
## Velocity Template for logout flow's concluding view-state (no propagation)
##
## Velocity context will contain the following properties
## flowExecutionUrl - the form action location
## flowRequestContext - the Spring Web Flow RequestContext
## flowExecutionKey - the SWF execution key (this is built into the flowExecutionUrl)
## profileRequestContext - root of context tree
## logoutContext - context with SPSession details for logout operation
## multiRPContext - context with RelyingPartyContexts and possibly SP UI information from the metadata
## encoder - HTMLEncoder class
## request - HttpServletRequest
## response - HttpServletResponse
## environment - Spring Environment object for property resolution
## custom - arbitrary object injected by deployer
##
#set ($activeIdPSessions = $logoutContext and !$logoutContext.getIdPSessions().isEmpty())
#set ($activeSPSessions = $logoutContext and !$logoutContext.getSessionMap().isEmpty())
#set ($regex = '(http|https):\/\/(?:.*\.)*(.+\..+?)\/')

#set ($activeIdPSessions = $logoutContext and !$logoutContext.getIdPSessions().isEmpty())
#set ($activeSPSessions = $logoutContext and !$logoutContext.getSessionMap().isEmpty())

#set ($redirectUrl = 'https://www.g-riseon.or.kr') 

## add sp path

## Method 1: multiRPContext에서 첫 번째 RP의 entityID 사용
#if ($multiRPContext && !$multiRPContext.getRelyingPartyContexts().isEmpty())
    #set ($rpContext = $multiRPContext.getRelyingPartyContexts().values().iterator().next())
    #if ($rpContext && $rpContext.getRelyingPartyId())
        #set ($entityId = $rpContext.getRelyingPartyId())
        ## EntityID에서 도메인 추출 (예: https://ecampus.dscu.ac.kr/saml/metadata -> https://ecampus.dscu.ac.kr)
        #if ($entityId.startsWith("http"))
            #set ($redirectUrl = $entityId.replaceAll("^(https?://[^/]+).*", "$1"))
        #end
    #end
#end

## Method 2: logoutContext의 세션 맵에서 SP URL 추출
#if ($activeSPSessions)
    #foreach ($spSession in $logoutContext.getSessionMap().keySet())
        ## SP 세션 키에서 URL 패턴 추출
        #if ($spSession.toString().contains("://"))
            #set ($spUrl = $spSession.toString())
            #set ($redirectUrl = $spUrl.replaceAll("^(https?://[^/]+).*", "$1"))
            #break
        #end
    #end
#end

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <meta http-equiv="refresh" content="3;url=$redirectUrl">
        <title>#springMessageText("idp.title", "Web Login Service")</title>
        <link rel="stylesheet" type="text/css" href="$request.getContextPath()/css/main.css">
    </head>

    <body>
    <div class="wrapper">
      <div class="container">
        <header>
          <img src="$request.getContextPath()#springMessage("idp.logo")" alt="#springMessageText("idp.logo.alt-text", "logo")">
        </header>

        <div class="content">
         ## <div class="column one">
          #if ($activeIdPSessions)
            <p>#springMessageText("idp.logout.cancelled", "Logout has been cancelled.")</p>
          #elseif ($activeSPSessions)
            <p style="font-size: 18pt">#springMessageText("idp.logout.local", "로그아웃 완료, PC방등 공공장소에 사용 중이라면 브라우져를 닫아주세요.")</p>
            <p style="font-size: 14pt; margin-top: 20px;">
              <span id="countdown">3</span>초 후 메인 페이지로 이동합니다...
            </p>
            <p style="margin-top: 10px;">
              <a href="$redirectUrl" style="color: #0066cc; text-decoration: underline;">지금 바로 이동하기</a>
            </p>
          #else
            <p>#springMessageText("idp.logout.complete", "The logout operation is complete, and no other services appear to have been accessed during this session.")</p>
            <p style="font-size: 14pt; margin-top: 20px;">
              <span id="countdown">3</span>초 후 메인 페이지로 이동합니다...
            </p>
            <p style="margin-top: 10px;">
              <a href="$redirectUrl" style="color: #0066cc; text-decoration: underline;">지금 바로 이동하기</a>
            </p>
          #end
        
         ## </div>
          #*
          <div class="column two">
            <ul class="list list-help">
              <li class="list-help-item"><a href="#springMessageText("idp.url.password.reset", '#')"><span class="item-marker">&rsaquo;</span> #springMessageText("idp.login.forgotPassword", "Forgot your password?")</a></li>
              <li class="list-help-item"><a href="#springMessageText("idp.url.helpdesk", '#')"><span class="item-marker">&rsaquo;</span> #springMessageText("idp.login.needHelp", "Need Help?")</a></li>
            </ul>
          </div>
          *#
        </div>
      </div>

      <!-- If SAML logout, complete the flow by adding a hidden iframe. -->
      #if ( $profileRequestContext.getProfileId().contains("saml2/logout") )
          <iframe style="display:none" src="$flowExecutionUrl&_eventId=proceed"></iframe>
      #end

      <footer>
        <div class="container container-footer">
          <p class="footer-text">#springMessageText("idp.footer", "Insert your footer text here.")</p>
        </div>
      </footer>
    </div>
    
    <script>
      // 카운트다운 기능
      let countdown = 3;
      const countdownElement = document.getElementById('countdown');
      
      if (countdownElement) {
        const timer = setInterval(function() {
          countdown--;
          countdownElement.textContent = countdown;
          
          if (countdown <= 0) {
            clearInterval(timer);
            window.location.href = '$redirectUrl';
          }
        }, 1000);
      }
    </script>
    
     </body>
</html>
